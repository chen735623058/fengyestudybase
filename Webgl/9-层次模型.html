<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>9-层次模型 | 七色枫叶的学习基地</title>
    <meta name="description" content="不积跬步无以至千里，不积小流无以成江河">
    
    
    <link rel="preload" href="/fengyestudybase/assets/css/0.styles.5e309cc9.css" as="style"><link rel="preload" href="/fengyestudybase/assets/js/app.0a47e211.js" as="script"><link rel="preload" href="/fengyestudybase/assets/js/22.09012641.js" as="script"><link rel="prefetch" href="/fengyestudybase/assets/js/10.30c47e52.js"><link rel="prefetch" href="/fengyestudybase/assets/js/11.4acf0b7f.js"><link rel="prefetch" href="/fengyestudybase/assets/js/12.01897755.js"><link rel="prefetch" href="/fengyestudybase/assets/js/13.927942cf.js"><link rel="prefetch" href="/fengyestudybase/assets/js/14.95996584.js"><link rel="prefetch" href="/fengyestudybase/assets/js/15.2a6554aa.js"><link rel="prefetch" href="/fengyestudybase/assets/js/16.2eacfb27.js"><link rel="prefetch" href="/fengyestudybase/assets/js/17.0faefb8a.js"><link rel="prefetch" href="/fengyestudybase/assets/js/18.dec666b8.js"><link rel="prefetch" href="/fengyestudybase/assets/js/19.61499d52.js"><link rel="prefetch" href="/fengyestudybase/assets/js/2.864db199.js"><link rel="prefetch" href="/fengyestudybase/assets/js/20.a5bcc6c6.js"><link rel="prefetch" href="/fengyestudybase/assets/js/21.48500825.js"><link rel="prefetch" href="/fengyestudybase/assets/js/23.c64fdaef.js"><link rel="prefetch" href="/fengyestudybase/assets/js/24.fb975750.js"><link rel="prefetch" href="/fengyestudybase/assets/js/25.84edc7a1.js"><link rel="prefetch" href="/fengyestudybase/assets/js/26.48396beb.js"><link rel="prefetch" href="/fengyestudybase/assets/js/27.496aa837.js"><link rel="prefetch" href="/fengyestudybase/assets/js/28.3cd6297d.js"><link rel="prefetch" href="/fengyestudybase/assets/js/29.98c70977.js"><link rel="prefetch" href="/fengyestudybase/assets/js/3.ae847aa1.js"><link rel="prefetch" href="/fengyestudybase/assets/js/30.92c849a4.js"><link rel="prefetch" href="/fengyestudybase/assets/js/31.6bc95938.js"><link rel="prefetch" href="/fengyestudybase/assets/js/32.d7c431d6.js"><link rel="prefetch" href="/fengyestudybase/assets/js/33.aa073227.js"><link rel="prefetch" href="/fengyestudybase/assets/js/34.fe2e3207.js"><link rel="prefetch" href="/fengyestudybase/assets/js/35.b8405c57.js"><link rel="prefetch" href="/fengyestudybase/assets/js/36.c29f2ab2.js"><link rel="prefetch" href="/fengyestudybase/assets/js/37.9daf48c3.js"><link rel="prefetch" href="/fengyestudybase/assets/js/38.882175dc.js"><link rel="prefetch" href="/fengyestudybase/assets/js/39.bc5c4f62.js"><link rel="prefetch" href="/fengyestudybase/assets/js/4.5053f111.js"><link rel="prefetch" href="/fengyestudybase/assets/js/40.c93261a7.js"><link rel="prefetch" href="/fengyestudybase/assets/js/41.c99bbfa0.js"><link rel="prefetch" href="/fengyestudybase/assets/js/42.748aa826.js"><link rel="prefetch" href="/fengyestudybase/assets/js/43.67d3a0a7.js"><link rel="prefetch" href="/fengyestudybase/assets/js/5.9688edc8.js"><link rel="prefetch" href="/fengyestudybase/assets/js/6.b4df5c4c.js"><link rel="prefetch" href="/fengyestudybase/assets/js/7.c58bccaa.js"><link rel="prefetch" href="/fengyestudybase/assets/js/8.fb18315f.js"><link rel="prefetch" href="/fengyestudybase/assets/js/9.3c445c9c.js">
    <link rel="stylesheet" href="/fengyestudybase/assets/css/0.styles.5e309cc9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fengyestudybase/" class="home-link router-link-active"><!----> <span class="site-name">七色枫叶的学习基地</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fengyestudybase/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">我的学习</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fengyestudybase/guide/" class="nav-link">前端开发综合知识</a></li><li class="dropdown-item"><!----> <a href="/fengyestudybase/JSbase/" class="nav-link">JS相关</a></li><li class="dropdown-item"><!----> <a href="/fengyestudybase/Webgl/" class="nav-link router-link-active">Webgl相关</a></li><li class="dropdown-item"><!----> <a href="/fengyestudybase/games/" class="nav-link">游戏相关</a></li><li class="dropdown-item"><!----> <a href="/fengyestudybase/readbook/" class="nav-link">读书专题---前端工程化体系设计与实践</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">我的项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://chen735623058.github.io/manifestEdit/dist/index.html#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  manifest编辑器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/chen735623058" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fengyestudybase/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">我的学习</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fengyestudybase/guide/" class="nav-link">前端开发综合知识</a></li><li class="dropdown-item"><!----> <a href="/fengyestudybase/JSbase/" class="nav-link">JS相关</a></li><li class="dropdown-item"><!----> <a href="/fengyestudybase/Webgl/" class="nav-link router-link-active">Webgl相关</a></li><li class="dropdown-item"><!----> <a href="/fengyestudybase/games/" class="nav-link">游戏相关</a></li><li class="dropdown-item"><!----> <a href="/fengyestudybase/readbook/" class="nav-link">读书专题---前端工程化体系设计与实践</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">我的项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://chen735623058.github.io/manifestEdit/dist/index.html#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  manifest编辑器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/chen735623058" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fengyestudybase/Webgl/" class="sidebar-link">主要包括一些Webgl相关的知识</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>webgl学习</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/fengyestudybase/Webgl/2-webgl-入门.html" class="sidebar-link">2-webgl 入门</a></li><li><a href="/fengyestudybase/Webgl/3-webgl-绘制和变换三角形.html" class="sidebar-link">3-绘制和变换三角形</a></li><li><a href="/fengyestudybase/Webgl/4-高级变换与动画基础.html" class="sidebar-link">4-高级变换和动画基础</a></li><li><a href="/fengyestudybase/Webgl/5-颜色与纹理.html" class="sidebar-link">5-颜色与纹理</a></li><li><a href="/fengyestudybase/Webgl/6-OpenGL ES着色器语言.html" class="sidebar-link">6-OpenGL ES着色器语言</a></li><li><a href="/fengyestudybase/Webgl/7-进入三维世界.html" class="sidebar-link">7-进入三维世界</a></li><li><a href="/fengyestudybase/Webgl/8-光照.html" class="sidebar-link">8-光照</a></li><li><a href="/fengyestudybase/Webgl/9-层次模型.html" class="active sidebar-link">9-层次模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fengyestudybase/Webgl/9-层次模型.html#一、学习要点" class="sidebar-link">一、学习要点</a></li><li class="sidebar-sub-header"><a href="/fengyestudybase/Webgl/9-层次模型.html#二、多个简单模型组成的复杂模型" class="sidebar-link">二、多个简单模型组成的复杂模型</a></li><li class="sidebar-sub-header"><a href="/fengyestudybase/Webgl/9-层次模型.html#_2-单关节模型" class="sidebar-link">2. 单关节模型</a></li><li class="sidebar-sub-header"><a href="/fengyestudybase/Webgl/9-层次模型.html#_3-多节点模型" class="sidebar-link">3.多节点模型</a></li><li class="sidebar-sub-header"><a href="/fengyestudybase/Webgl/9-层次模型.html#_4-着色器-和着色器程序对象，深入讲解（initshaders-函数作用）" class="sidebar-link">4. 着色器 和着色器程序对象，深入讲解（initShaders() 函数作用）</a></li><li class="sidebar-sub-header"><a href="/fengyestudybase/Webgl/9-层次模型.html#_5-总结" class="sidebar-link">5.总结</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="_9-层次模型"><a href="#_9-层次模型" aria-hidden="true" class="header-anchor">#</a> 9-层次模型</h1> <h2 id="一、学习要点"><a href="#一、学习要点" aria-hidden="true" class="header-anchor">#</a> 一、学习要点</h2> <p>本章的重点是层次模型，有了层次模型，你就可以在场景中处理复杂的三维模型，如游戏角色（而不仅仅是三角形或者立方体）</p> <ol><li>由多个简单的部件组成的复杂模型</li> <li>为复杂物体（机器人手臂）简历具有层次化结构的三维模型</li> <li>使用模型矩阵，模拟机器人手臂上的关节运动</li> <li>研究 initShader()函数的实现，了解初始化着色器的内部细节。</li></ol> <h2 id="二、多个简单模型组成的复杂模型"><a href="#二、多个简单模型组成的复杂模型" aria-hidden="true" class="header-anchor">#</a> 二、多个简单模型组成的复杂模型</h2> <blockquote><p>绘制多个小部件组成的复杂模型，最关键的问题是如何处理模型的整体移动，以及各个小部件间的相对移动。下图以人类手臂为例。
<img src="https://upload-images.jianshu.io/upload_images/10319049-4dd6a8b7c0839b49.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190517104715.png"></p></blockquote> <ul><li>手臂的每个部分可以环绕关节运动</li> <li>上臂可以绕肩关节运动，并带动前臂、手掌、手指一起运动。</li> <li>前臂可以绕肘关节运动，并带动手掌手指但不影响上臂。
以此类推 位于运动部位一下的其他部位会随着一起运动 而 位于关节部位以上的部位不受影响。此外所有的运动都是围绕关节的转动。</li></ul> <h3 id="_1-层级结构模型"><a href="#_1-层级结构模型" aria-hidden="true" class="header-anchor">#</a> 1. 层级结构模型</h3> <p>对于机器人手臂这样的层级结构模型，通常的做法是按照模型中的各个部件的层次顺序，从高到低逐一绘制，并在关节上应用模型矩阵。</p> <p>较为简单的情况 部件A转动带动部件B如果简单处理 B也施加A的旋转矩阵即可。比如上臂绕肩转动30度然后绘制肘关节以下也施加同样的一个模型矩阵。如下图</p> <p><img src="https://upload-images.jianshu.io/upload_images/10319049-ead304de21eb8b33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190517110158.png"></p> <p>如果肘关节的角度是10度和肩关节不一样，就要先施加上臂绕肩关节转动的30度矩阵，然后再施加前臂绕肘关节转动的十度的矩阵，将这两个矩阵相乘才是“ 肘关节模型矩阵”。</p> <h2 id="_2-单关节模型"><a href="#_2-单关节模型" aria-hidden="true" class="header-anchor">#</a> 2. 单关节模型</h2> <p>由两个立方体组成的机器人手臂。为了方便我们后面增加手掌和手指 我们将手臂倒过来，arm1为上臂，arm2为前臂
<img src="https://upload-images.jianshu.io/upload_images/10319049-4506c9909006b6f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190520101434.png"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 顶点着色器</span>
<span class="token keyword">var</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span>
    <span class="token string">'attribute vec4 a_Position;\n'</span> <span class="token operator">+</span> <span class="token comment">// 顶点位置数据</span>
    <span class="token string">'attribute vec4 a_Normal;\n'</span> <span class="token operator">+</span> <span class="token comment">// 法向量数据</span>
    <span class="token string">'uniform mat4 u_MvpMatrix;\n'</span> <span class="token operator">+</span> <span class="token comment">// 变换矩阵</span>
    <span class="token string">'uniform mat4 u_NormalMatrix;\n'</span> <span class="token operator">+</span> <span class="token comment">//逆转置矩阵</span>
    <span class="token string">'varying vec4 v_Color;\n'</span> <span class="token operator">+</span>
    <span class="token string">'void main() {\n'</span> <span class="token operator">+</span>
    <span class="token string">'  gl_Position = u_MvpMatrix * a_Position;\n'</span> <span class="token operator">+</span>
    <span class="token comment">// 光照相关 使得场景更逼真</span>
    <span class="token string">'  vec3 lightDirection = normalize(vec3(0.0, 0.5, 0.7));\n'</span> <span class="token operator">+</span> <span class="token comment">// 光的方向</span>
    <span class="token string">'  vec4 color = vec4(1.0, 0.4, 0.0, 1.0);\n'</span> <span class="token operator">+</span>
    <span class="token string">'  vec3 normal = normalize((u_NormalMatrix * a_Normal).xyz);\n'</span> <span class="token operator">+</span>
    <span class="token string">'  float nDotL = max(dot(normal, lightDirection), 0.0);\n'</span> <span class="token operator">+</span>
    <span class="token string">'  v_Color = vec4(color.rgb * nDotL + vec3(0.1), color.a);\n'</span> <span class="token operator">+</span>
    <span class="token string">'}\n'</span><span class="token punctuation">;</span>

<span class="token comment">// Fragment shader program</span>
<span class="token keyword">var</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span>
    <span class="token string">'#ifdef GL_ES\n'</span> <span class="token operator">+</span>
    <span class="token string">'precision mediump float;\n'</span> <span class="token operator">+</span>
    <span class="token string">'#endif\n'</span> <span class="token operator">+</span>
    <span class="token string">'varying vec4 v_Color;\n'</span> <span class="token operator">+</span>
    <span class="token string">'void main() {\n'</span> <span class="token operator">+</span>
    <span class="token string">'  gl_FragColor = v_Color;\n'</span> <span class="token operator">+</span>
    <span class="token string">'}\n'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">/</span>
    <span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'webgl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> gl <span class="token operator">=</span> <span class="token function">getWebGLContext</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to get the rendering context for WebGL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to intialize shaders.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取顶点坐标</span>
    <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to set the vertex information'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 清理背景 增加深度校验</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取uniform变量的存储位置</span>
    <span class="token keyword">var</span> u_MvpMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">'u_MvpMatrix'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> u_NormalMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">'u_NormalMatrix'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>u_MvpMatrix <span class="token operator">||</span> <span class="token operator">!</span>u_NormalMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to get the storage location'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 计算视图投影矩阵</span>
    <span class="token keyword">var</span> viewProjMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    viewProjMatrix<span class="token punctuation">.</span><span class="token function">setPerspective</span><span class="token punctuation">(</span><span class="token number">50.0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    viewProjMatrix<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span><span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">30.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 注册键盘事件</span>
    document<span class="token punctuation">.</span><span class="token function-variable function">onkeydown</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token function">keydown</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">draw</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token constant">ANGLE_STEP</span> <span class="token operator">=</span> <span class="token number">3.0</span><span class="token punctuation">;</span>    <span class="token comment">// 旋转角度的增量</span>
<span class="token keyword">var</span> g_arm1Angle <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">90.0</span><span class="token punctuation">;</span> <span class="token comment">// arm1的旋转角度</span>
<span class="token keyword">var</span> g_joint1Angle <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> <span class="token comment">// 关节1的旋转角度（也是arm2的角度）</span>

<span class="token keyword">function</span> <span class="token function">keydown</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>keyCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">38</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g_joint1Angle <span class="token operator">&lt;</span> <span class="token number">135.0</span><span class="token punctuation">)</span> g_joint1Angle <span class="token operator">+=</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">40</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g_joint1Angle <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">135.0</span><span class="token punctuation">)</span> g_joint1Angle <span class="token operator">-=</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">39</span><span class="token punctuation">:</span>
            g_arm1Angle <span class="token operator">=</span> <span class="token punctuation">(</span>g_arm1Angle <span class="token operator">+</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">360</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">37</span><span class="token punctuation">:</span>
            g_arm1Angle <span class="token operator">=</span> <span class="token punctuation">(</span>g_arm1Angle <span class="token operator">-</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">360</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">draw</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token comment">// v0-v1-v2-v3 front</span>
        <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token comment">// v0-v3-v4-v5 right</span>
        <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token comment">// v0-v5-v6-v1 up</span>
        <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token comment">// v1-v6-v7-v2 left</span>
        <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token comment">// v7-v4-v3-v2 down</span>
        <span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.5</span>  <span class="token comment">// v4-v7-v6-v5 back</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 法向量</span>
    <span class="token keyword">var</span> normals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token comment">// v0-v1-v2-v3 front</span>
        <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token comment">// v0-v3-v4-v5 right</span>
        <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token comment">// v0-v5-v6-v1 up</span>
        <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token comment">// v1-v6-v7-v2 left</span>
        <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token comment">// v7-v4-v3-v2 down</span>
        <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span>  <span class="token comment">// v4-v7-v6-v5 back</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 顶点索引</span>
    <span class="token keyword">var</span> indices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token comment">// front</span>
        <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>    <span class="token comment">// right</span>
        <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>   <span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span>    <span class="token comment">// up</span>
        <span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span>  <span class="token number">12</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span>    <span class="token comment">// left</span>
        <span class="token number">16</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span>  <span class="token number">16</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span>    <span class="token comment">// down</span>
        <span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span>  <span class="token number">20</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">23</span>     <span class="token comment">// back</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initArrayBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token string">'a_Position'</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initArrayBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token string">'a_Normal'</span><span class="token punctuation">,</span> normals<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>


    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">var</span> indexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>indexBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to create the buffer object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initArrayBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> attribute<span class="token punctuation">,</span> data<span class="token punctuation">,</span> type<span class="token punctuation">,</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to create the buffer object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> a_attribute <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a_attribute <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to get the storage location of '</span> <span class="token operator">+</span> attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_attribute<span class="token punctuation">,</span> num<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 坐标变换矩阵</span>
<span class="token keyword">var</span> g_modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g_mvpMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Arm1</span>
    <span class="token keyword">var</span> arm1Length <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">setTranslate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>g_arm1Angle<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Draw</span>

    <span class="token comment">// Arm2</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> arm1Length<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 　　　 <span class="token comment">//将手臂2向上移动10</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>g_joint1Angle<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绕Z轴旋转</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让立方体粗一点</span>
    <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Draw</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> g_normalMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//法线的旋转矩阵</span>

<span class="token comment">// 绘制立方体</span>
<span class="token keyword">function</span> <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 计算视图矩阵</span>
    g_mvpMatrix<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>viewProjMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_mvpMatrix<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>g_modelMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_MvpMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> g_mvpMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算发现变换矩阵</span>
    g_normalMatrix<span class="token punctuation">.</span><span class="token function">setInverseOf</span><span class="token punctuation">(</span>g_modelMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_normalMatrix<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_NormalMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> g_normalMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这次绘制的立方体和之前的位于原点的有点区别：</p> <p><img src="https://upload-images.jianshu.io/upload_images/10319049-f88d5a1b2cba5721.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190520113600.png"></p> <h2 id="_3-多节点模型"><a href="#_3-多节点模型" aria-hidden="true" class="header-anchor">#</a> 3.多节点模型</h2> <p>这一节绘制一个具有多个关节的完整机器人手臂，包括基座（base），上臂（arm1）， 前臂(arm2)，手掌（palm），两根手指（finger1 &amp; finger2）
结构如下图：
<img src="https://upload-images.jianshu.io/upload_images/10319049-5a5b0fb391a030ad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190520142023.png"></p> <p>这里面要注意绘制顺序 是从下往上的。另外指头的绘制上有一个区别 后面注释有添加解释。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span>
    <span class="token string">'attribute vec4 a_Position;\n'</span> <span class="token operator">+</span>
    <span class="token string">'attribute vec4 a_Normal;\n'</span> <span class="token operator">+</span>
    <span class="token string">'uniform mat4 u_MvpMatrix;\n'</span> <span class="token operator">+</span>
    <span class="token string">'uniform mat4 u_NormalMatrix;\n'</span> <span class="token operator">+</span>
    <span class="token string">'varying vec4 v_Color;\n'</span> <span class="token operator">+</span>
    <span class="token string">'void main() {\n'</span> <span class="token operator">+</span>
    <span class="token string">'  gl_Position = u_MvpMatrix * a_Position;\n'</span> <span class="token operator">+</span>
    <span class="token string">'  vec3 lightDirection = normalize(vec3(0.0, 0.5, 0.7));\n'</span>
    <span class="token string">'  vec4 color = vec4(1.0, 0.4, 0.0, 1.0);\n'</span> <span class="token operator">+</span>
    <span class="token string">'  vec3 normal = normalize((u_NormalMatrix * a_Normal).xyz);\n'</span> <span class="token operator">+</span>
    <span class="token string">'  float nDotL = max(dot(normal, lightDirection), 0.0);\n'</span> <span class="token operator">+</span>
    <span class="token string">'  v_Color = vec4(color.rgb * nDotL + vec3(0.1), color.a);\n'</span> <span class="token operator">+</span>
    <span class="token string">'}\n'</span><span class="token punctuation">;</span>


<span class="token keyword">var</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span>
    <span class="token string">'#ifdef GL_ES\n'</span> <span class="token operator">+</span>
    <span class="token string">'precision mediump float;\n'</span> <span class="token operator">+</span>
    <span class="token string">'#endif\n'</span> <span class="token operator">+</span>
    <span class="token string">'varying vec4 v_Color;\n'</span> <span class="token operator">+</span>
    <span class="token string">'void main() {\n'</span> <span class="token operator">+</span>
    <span class="token string">'  gl_FragColor = v_Color;\n'</span> <span class="token operator">+</span>
    <span class="token string">'}\n'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'webgl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> gl <span class="token operator">=</span> <span class="token function">getWebGLContext</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to get the rendering context for WebGL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to intialize shaders.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to set the vertex information'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Set the clear color and enable the depth test</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the storage locations of uniform variables</span>
    <span class="token keyword">var</span> u_MvpMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">'u_MvpMatrix'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> u_NormalMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">'u_NormalMatrix'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>u_MvpMatrix <span class="token operator">||</span> <span class="token operator">!</span>u_NormalMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to get the storage location'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Calculate the view projection matrix</span>
    <span class="token keyword">var</span> viewProjMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    viewProjMatrix<span class="token punctuation">.</span><span class="token function">setPerspective</span><span class="token punctuation">(</span><span class="token number">50.0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    viewProjMatrix<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span><span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">30.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Register the event handler to be called on key press</span>
    document<span class="token punctuation">.</span><span class="token function-variable function">onkeydown</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token function">keydown</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">draw</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Draw the robot arm</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token constant">ANGLE_STEP</span> <span class="token operator">=</span> <span class="token number">3.0</span><span class="token punctuation">;</span>     <span class="token comment">//变换一次变化的幅度</span>
<span class="token keyword">var</span> g_arm1Angle <span class="token operator">=</span> <span class="token number">90.0</span><span class="token punctuation">;</span>   <span class="token comment">// arm1的当前角度</span>
<span class="token keyword">var</span> g_joint1Angle <span class="token operator">=</span> <span class="token number">45.0</span><span class="token punctuation">;</span> <span class="token comment">// joint1的当前角度</span>
<span class="token keyword">var</span> g_joint2Angle <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token comment">// joint2的当前角度</span>
<span class="token keyword">var</span> g_joint3Angle <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token comment">// joint3的当前角度</span>

<span class="token keyword">function</span> <span class="token function">keydown</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>keyCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">40</span><span class="token punctuation">:</span> <span class="token comment">// Up arrow key -&gt; the positive rotation of joint1 around the z-axis</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g_joint1Angle <span class="token operator">&lt;</span> <span class="token number">135.0</span><span class="token punctuation">)</span> g_joint1Angle <span class="token operator">+=</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">38</span><span class="token punctuation">:</span> <span class="token comment">// Down arrow key -&gt; the negative rotation of joint1 around the z-axis</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g_joint1Angle <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">135.0</span><span class="token punctuation">)</span> g_joint1Angle <span class="token operator">-=</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">39</span><span class="token punctuation">:</span> <span class="token comment">// Right arrow key -&gt; the positive rotation of arm1 around the y-axis</span>
            g_arm1Angle <span class="token operator">=</span> <span class="token punctuation">(</span>g_arm1Angle <span class="token operator">+</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">360</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">37</span><span class="token punctuation">:</span> <span class="token comment">// Left arrow key -&gt; the negative rotation of arm1 around the y-axis</span>
            g_arm1Angle <span class="token operator">=</span> <span class="token punctuation">(</span>g_arm1Angle <span class="token operator">-</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">360</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">90</span><span class="token punctuation">:</span> <span class="token comment">// 'ｚ'key -&gt; the positive rotation of joint2</span>
            g_joint2Angle <span class="token operator">=</span> <span class="token punctuation">(</span>g_joint2Angle <span class="token operator">+</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">360</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">88</span><span class="token punctuation">:</span> <span class="token comment">// 'x'key -&gt; the negative rotation of joint2</span>
            g_joint2Angle <span class="token operator">=</span> <span class="token punctuation">(</span>g_joint2Angle <span class="token operator">-</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">360</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">86</span><span class="token punctuation">:</span> <span class="token comment">// 'v'key -&gt; the positive rotation of joint3</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g_joint3Angle <span class="token operator">&lt;</span> <span class="token number">60.0</span><span class="token punctuation">)</span>  g_joint3Angle <span class="token operator">=</span> <span class="token punctuation">(</span>g_joint3Angle <span class="token operator">+</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">360</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">67</span><span class="token punctuation">:</span> <span class="token comment">// 'c'key -&gt; the nagative rotation of joint3</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g_joint3Angle <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">60.0</span><span class="token punctuation">)</span> g_joint3Angle <span class="token operator">=</span> <span class="token punctuation">(</span>g_joint3Angle <span class="token operator">-</span> <span class="token constant">ANGLE_STEP</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">360</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Skip drawing at no effective action</span>
    <span class="token punctuation">}</span>
    <span class="token function">draw</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Coordinates（Cube which length of one side is 1 with the origin on the center of the bottom)</span>
    <span class="token keyword">var</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// v0-v1-v2-v3 front</span>
        <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// v0-v3-v4-v5 right</span>
        <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// v0-v5-v6-v1 up</span>
        <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// v1-v6-v7-v2 left</span>
        <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// v7-v4-v3-v2 down</span>
        <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span>  <span class="token comment">// v4-v7-v6-v5 back</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Normal</span>
    <span class="token keyword">var</span> normals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token comment">// v0-v1-v2-v3 front</span>
        <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token comment">// v0-v3-v4-v5 right</span>
        <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token comment">// v0-v5-v6-v1 up</span>
        <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token comment">// v1-v6-v7-v2 left</span>
        <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token comment">// v7-v4-v3-v2 down</span>
        <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span>  <span class="token comment">// v4-v7-v6-v5 back</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Indices of the vertices</span>
    <span class="token keyword">var</span> indices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token comment">// front</span>
        <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>    <span class="token comment">// right</span>
        <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>   <span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span>    <span class="token comment">// up</span>
        <span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span>  <span class="token number">12</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span>    <span class="token comment">// left</span>
        <span class="token number">16</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span>  <span class="token number">16</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span>    <span class="token comment">// down</span>
        <span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span>  <span class="token number">20</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">23</span>     <span class="token comment">// back</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write the vertex property to buffers (coordinates and normals)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initArrayBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token string">'a_Position'</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initArrayBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token string">'a_Normal'</span><span class="token punctuation">,</span> normals<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// Unbind the buffer object</span>
    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write the indices to the buffer object</span>
    <span class="token keyword">var</span> indexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>indexBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to create the buffer object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initArrayBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> attribute<span class="token punctuation">,</span> data<span class="token punctuation">,</span> type<span class="token punctuation">,</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create a buffer object</span>
    <span class="token keyword">var</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to create the buffer object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Write date into the buffer object</span>
    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Assign the buffer object to the attribute variable</span>
    <span class="token keyword">var</span> a_attribute <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a_attribute <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to get the storage location of '</span> <span class="token operator">+</span> attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_attribute<span class="token punctuation">,</span> num<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Enable the assignment of the buffer object to the attribute variable</span>
    gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Coordinate transformation matrix</span>
<span class="token keyword">var</span> g_modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g_mvpMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 清空颜色缓冲区和深度缓冲区背景色</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 绘制基座</span>
    <span class="token keyword">var</span> baseHeight <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">setTranslate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> baseHeight<span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Arm1</span>
    <span class="token keyword">var</span> arm1Length <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> baseHeight<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 移至基座</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>g_arm1Angle<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 旋转</span>
    <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">,</span> arm1Length<span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绘制</span>

    <span class="token comment">// Arm2</span>
    <span class="token keyword">var</span> arm2Length <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> arm1Length<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// Move to joint1</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>g_joint1Angle<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Rotate around the z-axis</span>
    <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">,</span> arm2Length<span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Draw</span>

    <span class="token comment">// A palm</span>
    <span class="token keyword">var</span> palmLength <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> arm2Length<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// Move to palm</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>g_joint2Angle<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Rotate around the y-axis</span>
    <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> palmLength<span class="token punctuation">,</span> <span class="token number">6.0</span><span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Draw</span>

    <span class="token comment">// Move to the center of the tip of the palm</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> palmLength<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Draw finger1</span>
    <span class="token function">pushMatrix</span><span class="token punctuation">(</span>g_modelMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里使用栈结构 主要是因为finger1和finger2相对的都是palm 所以finger2不能受到finger1的影响，需要保存finger1变换之前的矩阵</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>g_joint3Angle<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Rotate around the x-axis</span>
    <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_modelMatrix <span class="token operator">=</span> <span class="token function">popMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Draw finger2</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token operator">-</span>g_joint3Angle<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Rotate around the x-axis</span>
    <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> g_matrixStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储矩阵的栈</span>
<span class="token keyword">function</span> <span class="token function">pushMatrix</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将矩阵压入栈</span>
    <span class="token keyword">var</span> m2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_matrixStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">popMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将矩阵弹出栈</span>
    <span class="token keyword">return</span> g_matrixStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> g_normalMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Coordinate transformation matrix for normals</span>

<span class="token comment">// Draw rectangular solid</span>
<span class="token keyword">function</span> <span class="token function">drawBox</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> n<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> viewProjMatrix<span class="token punctuation">,</span> u_MvpMatrix<span class="token punctuation">,</span> u_NormalMatrix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushMatrix</span><span class="token punctuation">(</span>g_modelMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Save the model matrix</span>
    <span class="token comment">// Scale a cube and draw</span>
    g_modelMatrix<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Calculate the model view project matrix and pass it to u_MvpMatrix</span>
    g_mvpMatrix<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>viewProjMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_mvpMatrix<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>g_modelMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_MvpMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> g_mvpMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Calculate the normal transformation matrix and pass it to u_NormalMatrix</span>
    g_normalMatrix<span class="token punctuation">.</span><span class="token function">setInverseOf</span><span class="token punctuation">(</span>g_modelMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_normalMatrix<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_NormalMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> g_normalMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Draw</span>
    gl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_modelMatrix <span class="token operator">=</span> <span class="token function">popMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Retrieve the model matrix</span>
<span class="token punctuation">}</span>

</code></pre></div><p>用这种方法就可以绘制任意复杂的层次结构模型。我们只需要按照层次顺序，从高到低绘制部件，并在绘制具有兄弟部件的部件钱将模型矩阵亚茹栈 绘制完后再弹出即可。</p> <h2 id="_4-着色器-和着色器程序对象，深入讲解（initshaders-函数作用）"><a href="#_4-着色器-和着色器程序对象，深入讲解（initshaders-函数作用）" aria-hidden="true" class="header-anchor">#</a> 4. 着色器 和着色器程序对象，深入讲解（initShaders() 函数作用）</h2> <p>之前我们一直使用辅助函数initShaders()。它隐藏了建立和初始化着色器的细节。 我们本着好奇的目的探索一些这个是如何将字符串形式的GLSL ES代码编译为显卡中运行的着色器程序呢。</p> <p>具体分为以下7步。</p> <ol><li>创建着色器对象（gl.createShader()）</li> <li>向着色器对象中填充着色器程序的源代码（gl.shaderSource()）</li> <li>编译着色器（gl.compileShader()）</li> <li>创建程序对象（gl.createProgram()）</li> <li>为程序对象分配着色器(gl.attachShader())</li> <li>连接程序对象（gl.linkProgram）</li> <li>使用程序对象（gl.useProgram()）</li></ol> <p>名词解释：
着色器对象：着色器对象管理着一个顶点着色器或者一个片元着色器。每个着色器都有一个着色器对象。
程序对象：程序对象是管理着着色器对象的容器。WebGL中，一个程序对象必须包含一个顶点着色器和一个片元着色器。</p> <blockquote><p>创建着色器对象（gl.createShader()）</p></blockquote> <p>所有的着色器对象都必须通过调用 gl.createShader() 来创建
<img src="https://upload-images.jianshu.io/upload_images/10319049-4cc6e5577b2971b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190522165813.png"></p> <blockquote><p>指定着色器对象的代码（gl.shaderSource()）</p></blockquote> <p><img src="https://upload-images.jianshu.io/upload_images/10319049-7efff595e0746e02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190522170018.png"></p> <blockquote><p>编译着色器 （gl.compileShader()）</p></blockquote> <p>向着色器中传入源代码后，还需要编译才能使用。如果用新的代码地换掉了旧的代码，需要手动重新编译。
当调用编译函数时，如果着色器源代码存在错误，会出现编译错误，可以使用gl.getShaderParameter() 函数来检测着色器的状态该。</p> <p><img src="https://upload-images.jianshu.io/upload_images/10319049-13ba9f431a7d1097.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190522170414.png"></p> <p>调用gl.getShaderParameter(shader,pname) 将 pname 指定为 gl.COMPILE_STATUS就可以检测着色器是否编译成功。如果失败会返回false，可以通过gl.getShaderInfoLog() 来获取错误日志。</p> <p><img src="https://upload-images.jianshu.io/upload_images/10319049-52ceba66245dccf1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190522170712.png"></p> <blockquote><p>创建程序对象（gl.createProgram）</p></blockquote> <blockquote><p>为程序对象分配着色器对象（gl.attachShader()）</p></blockquote> <p><img src="https://upload-images.jianshu.io/upload_images/10319049-08cbe9a981729640.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190522171154.png"></p> <blockquote><p>连接程序对象（gl.linkProgram()）</p></blockquote> <p>在程序对象分配了两个着色器对象后，还需要将顶点着色器和片元着色器连接起来。</p> <p>连接的目的是保证：</p> <ol><li>顶点着色器和片元着色器的varying 变量同名同类型，且一一对应；</li> <li>顶点着色对每个varying变量赋了值;</li> <li>顶点着色器和片元你着色器中的同名uniform变量也是同类型的（不需要一一对应）</li> <li>着色器中的attribute uniform varying 变量没有超过着色器上限。</li></ol> <p><img src="https://upload-images.jianshu.io/upload_images/10319049-91a1bb9a80c5f338.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="微信图片_20190522171642.png"></p> <blockquote><p>告知 Webgl系统所使用的程序对象 （gl.useProgram(program)）</p></blockquote> <h2 id="_5-总结"><a href="#_5-总结" aria-hidden="true" class="header-anchor">#</a> 5.总结</h2> <p>本章我们学习了WebGL对于层次模型的绘制，并讲解了initShaders()函数的创建细节。
至此我们学习了所有webGL的基础知识，我们运用这些基础知识应该可以创建出复杂的图形了，但是好像还是少点什么。感觉我们的交互不够或者是复杂图形的顶点那么多怎么去找。下面我们会学习一些图形序方面的高级技术，并了解Webgl和他们是如何配合使用的</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/fengyestudybase/assets/js/app.0a47e211.js" defer></script><script src="/fengyestudybase/assets/js/22.09012641.js" defer></script>
  </body>
</html>
